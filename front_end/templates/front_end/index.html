{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tenjin</title>
  <script src="//cdn.jsdelivr.net/d3js/3.5.6/d3.min.js"></script>
  <script src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js"></script>
  <script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
  <script src="//cdn.jsdelivr.net/humanize/0.0.9/humanize.min.js"></script>
  <script src="{% static 'front_end/formatters.js' %}"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="{% static 'front_end/css/normalize.css' %}">
  <link rel="stylesheet" href="{% static 'front_end/css/skeleton.css' %}">
  <link rel="stylesheet" href="{% static 'front_end/css/base.css' %}">
  <link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css">
</head>
<body>
<div class="container">

<section>
<div class="title row">
<div class="twelve column">
<h2>Tenjin</h2>
<p>{% lorem %}</p>
</div>
</div>
</section>
<section>
<h3>Live usage</h3>
<div class="row">
  <div class="one-half column resources">
    <h4>Overall resource usage</h4>
  </div>
  <div class="one-half column overview loading">
    <h4>Per-project distribution</h4>
    <div class="instructions">
    <p>Click on a piece of pie to filter data.</p>
    <p style="display:none">Click again to reset.</p>
    </div>
  </div>
</div>
<div class="row">
  <div class="twelve column live loading">
    <table class="display">
    </table>
  </div>
</div>
</section>
<section>
<h3>Historical usage</h3>
<div class="row">
  <div class="twelve column">
    <h4>Historical usage</h4>
    <p>{% lorem %}</p>
  </div>
</div>
</section>

</div>{# /container #}
<script>
(function($) {
    // array of
    //    sel : selector for applying loading/error classes
    //    dep : sqldump keys for required data (will be stored in g[key]
    //    fun : function to call after all dep data loaded (will be called with deps element as argument)
    var deps = [
        {
            sel : '.resources',
            dep : ['hypervisors', 'live_instances'],
            fun : report_resources,
        },
        {
            sel : '.overview',
            dep : ['projects', 'live_instances'],
            fun : report_overview,
        },
        {
            sel : '.live',
            dep : ['projects', 'flavours', 'live_instances'],
            fun : report_live,
        },
    ];
    var g = {};

    // overview elements
    var live_tbl;

    // get json data from sqldump app
    function sqldump(query_key, success, error) {
        $.ajax({
            url : '/dump/q/' + query_key, // TODO fragile
            headers : {
                'accept' : 'application/json',
            },
            success : success,
            error : error != undefined ? error : function(data) {
                console.log("Couldn't get sqldump for key '"+query_key+"'");
            },
        });
    }

    function change_pie(sel, pie, path, arc) {
        // change data of pie chart based on <select> value
        pie.value(function(d) { return d[sel.value]; });
        path = path.data(pie);
        path.transition().duration(750).attrTween('d', function(a) {
            // arc tween
            var i = d3.interpolate(this._current, a);
            this._current = i(0);
            return function(t) {
                return arc(i(t));
            };
        });
    }

    function report_overview(dep) {
        // which fields might we want to sum over?
        var agg_fields = ['vcpus','memory','wall_time','allocation_time'];

        // aggregate data
        var agg_live_instances = Object.keys(g.projects).map(function(puuid) {
            var ret = {puuid : puuid};
            agg_fields.forEach(function(field) {
                ret[field] = g.live_instances.reduce(function(val, row) {
                    return val + row[field] * (row.project_id == puuid);
                }, 0);
            });
            return ret;
        });

        // generate pie chart; thanks to http://bl.ocks.org/mbostock/1346410
        var width = 300, height = 300, radius = Math.min(width, height)*0.5; // TODO responsive svg

        var color = d3.scale.category20();

        var pie = d3.layout.pie()
            .value(function(d) { return d[agg_fields[0]]; });

        var arc = d3.svg.arc()
            .innerRadius(0)
            .outerRadius(radius - 10);

        var svg = d3.select(dep.sel).insert('svg', ':nth-child(2)') // insert after heading
            .attr('width', width)
            .attr('height', height)
          .append('g')
            .attr('transform', 'translate(' + width*0.5 + ',' + height*0.5 + ')');

        var path = svg.datum(agg_live_instances).selectAll('path')
            .data(pie)
          .enter().append('path')
            .attr('class', 'arc')
            .attr('fill', function(d, i) { return color(i); })
            .attr('d', arc)
            .on('mouseover', function(d, i) {}) // TODO eventually handle these
            .on('mouseout',  function(d, i) {})
            .on('click', function(d, i) {
                var col = live_tbl.column('.project_id');
                d3.selectAll('path').classed('selected', false);
                if(col.search() == d.data.puuid) {
                    // deselecting
                    col.search('').draw();
                } else {
                    // selecting
                    col.search(d.data.puuid).draw();
                    d3.select(this).classed('selected', true);
                }
                $(dep.sel).find('p').toggle();
             })
            .each(function(d) { this._current = d; }); // store initial angles

        // done loading pie chart now
        d3.select(dep.sel).classed('loading', false);

        // generate <select> for controlling pie
        d3.select(dep.sel)
          .insert('select', 'svg')
            .on('change',function() { change_pie(this, pie, path, arc); })
          .selectAll('option')
            .data(agg_fields)
          .enter().append('option')
            .text(function(d) { return d; })

        // TODO improve tooltips
        path
          .append('svg:title') // idk if you're even allowed to put a title inside a path
            .text(function(d) { return g.projects[d.data.puuid].display_name+': '+d.data[d3.select('div.overview select').property('value')]; });
    }

    function report_live(dep) {
        // show table
        live_tbl = $('.live table').DataTable({
            dom : 't', // show table only
            data : g.live_instances,
            columns : [
                {
                    title : 'Created',
                    data : 'created',
                    className : 'date',
                    render : {
                        display : Formatters.relativeDateDisplay,
                    },
                },
                {
                    title : 'Project',
                    data : function(live_instance) {
                        return g.projects[live_instance.project_id].display_name;
                    },
                },
                {
                    title : 'Wall time',
                    data : 'wall_time',
                    render : { display : Formatters.timeDisplay },
                },
                {
                    title : 'CPU time',
                    data : 'cpu_time',
                    render : { display : Formatters.timeDisplay },
                },
                {
                    title : 'Name',
                    data : 'name',
                },
                {
                    title : 'Flavour',
                    data : 'flavour',
                    render : {
                        display : Formatters.flavourDisplay(g.flavours),
                        filter : function(flavour_id) { return g.flavours[flavour_id].name; }, // TODO hello
                    },
                },
                {
                    data : 'project_id',
                    className : 'project_id', // to identify column for filtering
                    visible : false,
                },
                {
                    data : 'uuid',
                    visible : false,
                },
            ],
            order : [[0, 'desc']], // order by first col: most recently created first
            processing : true,
        });
        $(dep.sel).removeClass('loading');
    }

    function report_resources(dep) {
        var agg_fields = ['cpus', 'memory', 'local_storage'];
        var sum_fn = {
            cpus          : function(val, inst) { return val + (+inst.vcpus); },
            memory        : function(val, inst) { return val + (+inst.memory); },
            local_storage : function(val, inst) { return val + (+inst.root) + (+inst.ephemeral); }, // TODO is this right
        };
        var res_tot = {}, res_used = {key:'used'}, res_free = {key:'free'};
        agg_fields.forEach(function(f) {
            res_tot[f] = g.hypervisors.reduce(function(val, h) {
                return val + (+h[f]);
            }, 0);
            res_used[f] = g.live_instances.reduce(sum_fn[f], 0);
            res_free[f] = res_tot[f] - res_used[f];
        });
        var data = [res_used, res_free];

        // generate pie chart
        var width = 300, height = 300, radius = Math.min(width, height)*0.5; // TODO responsive svg

        var color = d3.scale.category20();

        var pie = d3.layout.pie()
            .value(function(d) { return d[agg_fields[0]]; });

        var arc = d3.svg.arc()
            .innerRadius(0)
            .outerRadius(radius - 10);

        var svg = d3.select(dep.sel).append('svg')
            .attr('width', width)
            .attr('height', height)
          .append('g')
            .attr('transform', 'translate(' + width*0.5 + ',' + height*0.5 + ')');

        var path = svg.datum(data).selectAll('path')
            .data(pie)
          .enter().append('path')
            .attr('class', function(d, i) { return 'res-'+d.data.key; })
            .attr('fill', function(d, i) { return color(i); })
            .attr('d', arc)
            .on('mouseover', function(d, i) {}) // TODO eventually handle these
            .on('mouseout',  function(d, i) {})
            .on('click', function(d, i) {
                // TODO this !important
             })
            .each(function(d) { this._current = d; }); // store initial angles

        // done loading pie chart now
        d3.select(dep.sel).classed('loading', false);

        // generate <select> for controlling pie
        d3.select(dep.sel)
          .insert('select', 'svg')
            .on('change',function() { change_pie(this, pie, path, arc); })
          .selectAll('option')
            .data(agg_fields)
          .enter().append('option')
            .text(function(d) { return d; })

        // TODO improve tooltips
        path
          .append('svg:title') // idk if you're even allowed to put a title inside a path
            .text(function(d) { return d.data.key; });
    }

    // putting <script> at the end of document makes sure we have all the dom we need
    // concat all depdendency query keys, then filter out duplicates (topsort would be too cool)
    var dep_keys = deps.reduce(function(val, dep) { return val.concat(dep.dep); }, []);
    dep_keys = dep_keys.filter(function(dep, i) { return dep_keys.indexOf(dep)==i; });
    dep_keys.forEach(function(key) { sqldump(key,
        // get all preload data, then call success
        function(data) {
            // maybe restructure data, then store
            if(key == 'projects') {
                ps = {}
                data.forEach(function(p) {
                    ps[p.uuid] = p;
                });
                data = ps;
            } else if(key == 'flavours') {
                fs = {}
                data.forEach(function(f) {
                    fs[f.id] = f;
                });
                data = fs;
            }
            g[key] = data;
            
            // check if any new report functions can now be called
            // TODO not sure if a race condition is possible here in js (single-threaded execution should be ok)
            deps.forEach(function(dep) {
                if(!dep.done && dep.dep.every(function(k) { return k in g; })) {
                    dep.done = true;
                    dep.fun(dep);
                }
            });
        },
        function(err) {
            // error
            deps.forEach(function(dep) {
                if(dep.dep.indexOf(key) != -1) {
                    $(dep.sel).removeClass('loading');
                    $(dep.sel).addClass('error');
                    console.log('error (%i %s) for query "%s"', err.status, err.statusText, key);
                }
            });
        }
    )});
})(jQuery);
</script>
</body>
</html>
