{% load staticfiles %}
<!DOCTYPE html>
<head>
<title>yes</title>
<script src="//cdn.jsdelivr.net/d3js/3.5.6/d3.min.js"></script>
<script src="//cdn.jsdelivr.net/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="{% static 'front_end/base.css' %}">
<style>
* {
    margin: 0;
    padding: 0;
}
body {
    font-family: sans-serif;
    padding: 1em;
}
body > h1 {
    font-size: 2em;
}
.ct-label {
    fill: rgba(255,255,255,1);
    font-weight: bold;
}
div.query {
    margin-top: 4em;
    background: #fff;
    border: 1px solid #ccc;
    padding: 20px;
}
div.query > h1 {
    font-size: 1.5em;
    border-bottom: 1px solid #ccc;
    background: #eee;
    margin: 0;
    padding: 0.5em 0.666em;
    margin: -20px -20px 20px -20px;
}
div.piepiepie {
    width: 400px;
    display: inline-block;
}
div.piepiepie > div {
    display: table-cell;
}
div.piepiepie > div.ct-chart {
}
div.piepiepie > div.wrapper {
    vertical-align: top;
}
div.wrapper > * {
    margin: 1em 0 0 2em;
}
div.piepiepie select {
    display:block;
}
div.piepiepie ul {
    list-style-type: none;
    display:inline-block;
}
div.piepiepie ul * {
    white-space: nowrap;
    line-height: 1.6em;
}
div.piepiepie li svg {
    margin-right: 1em;
}
@media (max-width: 850px ) { /* if two piepiepies won't fit, make one fill all space */
    div.piepiepie {
        width: 100%;
    }
    div.piepiepie > div {
        display: block;
        width: 100%;
    }
    div.piepiepie li {
        display: inline-block;
        margin-right: 1em;
    }
    div.piepiepie li svg {
        margin-right: 0.2em;
    }
}
table.loading {
    height:3em;
    width:100%;
}
table.loading::after {
    color: #900;
    text-align:center;
    content: 'loading';
}
</style>
</head>
<body>
<h1>report</h1>

<div class="query" id="rabs">
<h1>Overview</h1>
<table class="loading display">
</table>
</div>

<script>
(function($) {
    // query keys whose data should be loaded before any other data
    var preload = {'projects':undefined, 'flavours':undefined};

    // get json data from sqldump app
    function sqldump(query_key, success, error) {
        $.ajax({
            url : '/dump/q/' + query_key, // TODO fragile
            headers : {
                'accept' : 'application/json',
            },
            success : success,
            error : error != undefined ? error : function(data) {
                console.log("Couldn't get sqldump for key '"+query_key+"'");
            },
        });
    }

    // get all preload data, then call success
    function fetch_preload(key, success) {
        sqldump(key, function(data) {
            // restructure data to index by uuid (assumes uuid is unique.... TY OPENSTACK)
            preload[key] = {};
            data.forEach(function(row) {
                preload[key][row.uuid] = row;
            });

            // check if any preload values are still undefined
            if(Object.keys(preload).some(function(key) { return preload[key] == undefined; })) {
                // TODO not sure if a race condition is possible here in js (single-threaded execution should be ok)
                return;
            }

            // preloading is now all done, hooray
            success();
        });
    }

    function report() {
        // let's use d3 to make a table showing live instances
        // later we'll make something pretty instead of a table

        sqldump('live_instances', function(data) {
            if(data.length == 0) {
                // TODO handle
                return;
            }

            var tbl = d3.select('#rabs table');
            if(tbl.classed('loading')) {
                tbl.classed('loading', false); // remove .loading if it's there (which it will be until i make the loading process pretty and smart)
            }
            
            // generate head
            var cols = Object.keys(data[0]);
            tbl.append('thead').append('tr')
              .selectAll('th')
                .data(cols)
              .enter().append('th')
                .text(function(d) { return d; });

            // generate body
            tbl.append('tbody')
              .selectAll('tr')
                .data(data)
              .enter().append('tr')
              .selectAll('td')
                .data(function(row) {
                    return cols.map(function(col) {
                        return row[col];
                    });
                })
              .enter().append('td')
                .html(function(d) { return d; });

            // show table TODO for development only
            $(tbl.node()).DataTable();
        });
    }

    // giant tables are annoying TODO for development only
    $(function() {
        $('div.query > h1').click(function(e) {
            $(this).siblings().toggle(100);
        });
    });

    // putting <script> at the end of document makes sure we have all the dom we need
    Object.keys(preload).forEach(function(key) {
        fetch_preload(key, report);
    });
})(jQuery);
</script>

</body>
</html>
